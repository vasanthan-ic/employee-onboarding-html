<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login | InheritCloud</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../assets/img/logo.ico" sizes="any" />

  <!-- Core styles -->
  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/css/layout.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <link rel="stylesheet" href="../assets/css/pages/login.css" />
  <style>
    .auth-container { min-height: 100dvh; display: grid; place-items: center; padding: 40px; }
    .auth-card { width: 100%; max-width: 520px; padding: 40px 36px; }
    .auth-title { font-size: 28px; margin-top: 8px; }
    .auth-subtitle { font-size: 16px; margin: 10px 0 28px; }
    .form-field { margin-bottom: 20px; }
    .brand { margin-bottom: 14px; }
    .brand-logo { width: 200px; height: auto; }
    input[type="text"], input[type="password"] { padding: 14px; font-size: 16px; }
    .btn { padding: 12px 16px; font-size: 16px; }
  </style>
</head>
<body>
  <main class="container auth-container">
    <section class="card auth-card" role="form" aria-labelledby="login-title">
      <div class="brand">
        <img src="../assets/img/logo.jpeg" alt="InheritCloud" class="brand-logo" />
      </div>

      <h1 id="login-title" class="auth-title">Sign in</h1>
      <p class="auth-subtitle">Access your InheritCloud dashboard</p>

      <form id="loginForm" novalidate>
        <div class="form-field">
          <label for="userId">User ID</label>
          <input
            type="text"
            id="userId"
            name="userId"
            inputmode="email"
            autocomplete="username"
            placeholder="name@company.com"
            required
            aria-required="true"
          />
          <small class="field-hint">Use your corporate ID or email</small>
          <p class="field-error" id="userIdError" role="alert"></p>
        </div>

        <div class="form-field">
          <label for="password">Password</label>
          <div class="input-with-action">
            <input
              type="password"
              id="password"
              name="password"
              autocomplete="current-password"
              placeholder="••••••••"
              required
              minlength="8"
              aria-required="true"
            />
            <button type="button" class="btn-text" id="togglePassword">Show</button>
          </div>
          <p class="field-error" id="passwordError" role="alert"></p>
        </div>

        <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
          Sign in
          <span class="btn-spinner" aria-hidden="true"></span>
        </button>

        <div class="alert" id="formAlert" role="status"></div>
      </form>

      <footer class="auth-footer">
        <img src="../assets/img/logo-mark.svg" alt="" class="brand-mark" />
        <span>© <span id="year"></span> InheritCloud</span>
      </footer>
    </section>
  </main>

<!-- Import API module -->
<script type="module">
  import { apiRequest, ENDPOINTS } from "../assets/js/api.js";

  async function apiLogin(userId, password) {
    return apiRequest(ENDPOINTS.login, {
      method: "POST",
      body: { userId, password },
    });
  }

  function saveTokenByRole(token, role) {
    if (role === "HR") localStorage.setItem("HR_AUTH_TOKEN", token);
    else if (role === "ONBOARD") localStorage.setItem("ONBOARD_AUTH_TOKEN", token);
  }

  function decodeJwtPayload(token) {
    try {
      const [, payload] = token.split(".");
      return JSON.parse(atob(payload.replace(/-/g, "+").replace(/_/g, "/")));
    } catch {
      return null;
    }
  }

  function routeByRole(role) {
    if (role === "HR") window.location.assign("hr-dashboard.html");
    else if (role === "ONBOARD") window.location.assign("onboard-documents-dashboard.html");
  }

  // --- DOM elements ---
  const form = document.getElementById("loginForm");
  const userIdEl = document.getElementById("userId");
  const passwordEl = document.getElementById("password");
  const togglePasswordBtn = document.getElementById("togglePassword");
  const alertEl = document.getElementById("formAlert");
  const submitBtn = document.getElementById("submitBtn");
  const yearEl = document.getElementById("year");

  yearEl.textContent = new Date().getFullYear();

  function setLoading(b) {
    submitBtn.disabled = b;
    const sp = submitBtn.querySelector(".btn-spinner");
    if (sp) sp.style.display = b ? "inline-block" : "none";
  }

  function showAlert(message, type = "error") {
    alertEl.textContent = message;
    alertEl.className = `alert alert--${type}`;
  }

  function validate() {
    let valid = true;
    document.getElementById("userIdError").textContent = "";
    document.getElementById("passwordError").textContent = "";

    if (!userIdEl.value.trim()) {
      document.getElementById("userIdError").textContent = "Enter your User ID";
      valid = false;
    }
    if (!passwordEl.value.trim()) {
      document.getElementById("passwordError").textContent = "Enter your password";
      valid = false;
    }
    return valid;
  }

  togglePasswordBtn.addEventListener("click", () => {
    const isPwd = passwordEl.type === "password";
    passwordEl.type = isPwd ? "text" : "password";
    togglePasswordBtn.textContent = isPwd ? "Hide" : "Show";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!validate()) return;

    setLoading(true);
    showAlert("");

    try {
      const data = await apiLogin(userIdEl.value.trim(), passwordEl.value.trim());
      if (!data?.Authorization_Token) throw new Error("No token received");

      const decoded = decodeJwtPayload(data.Authorization_Token);
      const role = decoded?.role || data.role;
      if (!role) throw new Error("No role found");

      saveTokenByRole(data.Authorization_Token, role);
      showAlert("Login successful. Redirecting…", "success");
      setTimeout(() => routeByRole(role), 500);
    } catch (err) {
      showAlert(`Login failed: ${err.message}`, "error");
    } finally {
      setLoading(false);
    }
  });
</script>


</body>
</html>
